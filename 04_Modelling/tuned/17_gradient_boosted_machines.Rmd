---
title: "R Notebook"
output: html_notebook
---

# Gradient Boosted Machines

## Set-Up

```{r message=FALSE}
library(tidyverse)
library(h2o)
library(here)

source("../../../../scripts/h2o.gridResults.R")
```

```{r message=FALSE, warning=FALSE}
h2o.init()
h2o.removeAll()
```

## Baseline model

-   no feature selection

-   no feature engineering

-   no hyper-parameter tuning

-   use class balancing and stratified 10-fold cross-validation

```{r}
train <- read_rds(here("00_Data/processed/for_analysis/diabetes_train.rds"))
```

```{r message=FALSE}
train_h2o <- as.h2o(train)
```

```{r}
y <- "readmitted"
x <- setdiff(names(train), y)
      
default_model <-
    h2o.gbm(
        x = x,
        y = y,
        training_frame = train_h2o,
        model_id = "default_model",
        balance_classes = TRUE,
        nfolds = 10,
        fold_assignment = "Stratified",
        seed = 1234
    )
```

```{r}
h2o.auc(default_model, train = TRUE, xval = TRUE)
```

Default model using baseline data appears to over-fit the training data resulting in poor performance using cross-validation.

## Tuned baseline data model

### Random grid search

```{r}
hyper_params <- list(
    max_depth       = c(1:10),
    min_rows        = c(1 , 5, 10, 20),
    sample_rate     = seq(0.1, 1.0, 0.1),
    col_sample_rate =seq(0.1, 1.0, 0.1),
    learn_rate      = c(0.01, 0.05, 0.1, 0.2)
)

baseline_grid <- h2o.grid(
    algorithm = "gbm",
    grid_id = "random_grid",
    x = x,
    y = y,
    training_frame = train_h2o,
    nfolds = 5,
    fold_assignment = "Stratified",
    balance_classes = TRUE,
    seed = 1234,
    hyper_params = hyper_params,
    search_criteria = list(
        strategy = "RandomDiscrete",
        max_models = 25,
        seed = 1234),
    ntrees = 100,
    stopping_rounds = 5,
    stopping_metric = "AUC",
    stopping_tolerance = 0.001
)

random_grid_summary <- h2o.gridResults("random_grid", "auc", TRUE)

random_grid_summary %>% 
    pivot_longer(cols = c(col_sample_rate:sample_rate)) %>% 
    ggplot(aes(value, auc, color = name)) +
    geom_point() +
    facet_wrap(~ name, scales = "free_x") +
    theme_bw()
```

None of these models performed well so no further tuning appropriate.

Repeat process using filtered dataset.

## Filtered data

```{r}
# tidy cluster and environment
rm(list = ls())
h2o.removeAll()

h2o.gridResults <-
    function(grid_id, sort_by, decreasing) {
        results <-
            h2o.getGrid(grid_id = grid_id,
                        sort_by = sort_by,
                        decreasing = decreasing)
        results_tbl <- as_tibble(results@summary_table)
        
        return(results_tbl)
    }
```

```{r}
# load new data
train <- read_rds(here("00_Data/processed/for_analysis/diabetes_filtered_train.rds"))
```

```{r}
# export to h2o cluster
train_h2o <- as.h2o(train, destination_frame = "train")

y <- "readmitted"
x <- setdiff(names(train), y)
```

```{r}
hyper_params <- list(
    max_depth       = c(1:7),
    min_rows        = c(1 , 5, 10, 20),
    sample_rate     = seq(0.1, 1.0, 0.1),
    col_sample_rate =seq(0.2, 1.0, 0.2)
)

random_grid <- h2o.grid(
    algorithm = "gbm",
    grid_id = "random_grid",
    x = x,
    y = y,
    training_frame = train_h2o,
    nfolds = 5,
    fold_assignment = "Stratified",
    balance_classes = TRUE,
    seed = 1234,
    hyper_params = hyper_params,
    search_criteria = list(
        strategy = "RandomDiscrete",
        max_models = 25,
        seed = 1234),
    ntrees = 100,
    stopping_rounds = 5,
    stopping_metric = "AUC",
    stopping_tolerance = 0.001
)

random_grid_summary <- h2o.gridResults("random_grid", "auc", TRUE)

random_grid_summary %>% 
    pivot_longer(cols = c(col_sample_rate:sample_rate)) %>% 
    ggplot(aes(value, auc, color = name)) +
    geom_point() +
    facet_wrap(~ name, scales = "free_x") +
    theme_bw()
```

```{r}
hyper_params <- list(
    max_depth       = c(1:3),
    min_rows        = c(1:10),
    sample_rate     = seq(0.2, 1.0, 0.2),
    col_sample_rate =seq(0.2, 1.0, 0.2)
)

random_grid <- h2o.grid(
    algorithm = "gbm",
    grid_id = "random_grid",
    x = x,
    y = y,
    training_frame = train_h2o,
    nfolds = 5,
    fold_assignment = "Stratified",
    balance_classes = TRUE,
    seed = 1234,
    hyper_params = hyper_params,
    search_criteria = list(
        strategy = "RandomDiscrete",
        max_models = 25,
        seed = 1234),
    ntrees = 100,
    stopping_rounds = 5,
    stopping_metric = "AUC",
    stopping_tolerance = 0.001
)

random_grid_summary <- h2o.gridResults("random_grid", "auc", TRUE)

random_grid_summary %>% 
    pivot_longer(cols = c(col_sample_rate:sample_rate)) %>% 
    ggplot(aes(value, auc, color = name)) +
    geom_point() +
    facet_wrap(~ name, scales = "free_x") +
    theme_bw()
```

```{r}
hyper_params <- list(
    max_depth       = c(1:3),
    min_rows        = c(1, 3, 6, 9),
    sample_rate     = 0.4,
    col_sample_rate = c(0.1, 0.2, 0.3)
)

exhaustive_grid <- h2o.grid(
    algorithm = "gbm",
    grid_id = "exhaustive_grid",
    x = x,
    y = y,
    training_frame = train_h2o,
    nfolds = 5,
    fold_assignment = "Stratified",
    balance_classes = TRUE,
    seed = 1234,
    hyper_params = hyper_params,
    stopping_rounds = 5,
    stopping_metric = "AUC",
    stopping_tolerance = 0.001
)

exhaustive_grid_summary <- h2o.gridResults("exhaustive_grid", "auc", TRUE)

exhaustive_grid_summary %>% 
    pivot_longer(cols = c(col_sample_rate:sample_rate)) %>% 
    ggplot(aes(value, auc, color = name)) +
    geom_point() +
    facet_wrap(~ name, scales = "free_x") +
    theme_bw()
```

```{r}
filtered_tuned_gbm <- 
    exhaustive_grid_summary %>% 
    slice_head(n = 1) %>%
    pull(model_ids) %>% 
    h2o.getModel()

h2o.saveModel(filtered_tuned_gbm, path = here("04_Modelling/models/filtered_tuned_models/"), filename = "filtered_tuned_GBM")
```

## Engineered data

```{r}
# tidy cluster and environment
rm(list = ls())
h2o.removeAll()

h2o.gridResults <-
    function(grid_id, sort_by, decreasing) {
        results <-
            h2o.getGrid(grid_id = grid_id,
                        sort_by = sort_by,
                        decreasing = decreasing)
        results_tbl <- as_tibble(results@summary_table)
        
        return(results_tbl)
    }
```

```{r}
# load new data
train <- read_rds(here("00_Data/processed/for_analysis/diabetes_engineered_filtered_train.rds"))
```

```{r}
# export to h2o cluster
train_h2o <- as.h2o(train, destination_frame = "train")

y <- "readmitted"
x <- setdiff(names(train), y)
```

```{r}
hyper_params <- list(
    max_depth       = c(1:10),
    min_rows        = c(1, 5, 10, 20),
    sample_rate     = c(0.1, 0.25, 0.5, 0.75, 0.95, 1),
    col_sample_rate = c(0.1, 0.25, 0.5, 0.75, 0.95, 1)
)

random_grid <- h2o.grid(
    algorithm = "gbm",
    grid_id = "random_grid",
    x = x,
    y = y,
    training_frame = train_h2o,
    nfolds = 5,
    fold_assignment = "Stratified",
    balance_classes = TRUE,
    seed = 1234,
    hyper_params = hyper_params,
    search_criteria = list(
        strategy = "RandomDiscrete",
        max_models = 25,
        seed = 1234),
    ntrees = 100,
    stopping_rounds = 5,
    stopping_metric = "AUC",
    stopping_tolerance = 0.001
)

random_grid_summary <- h2o.gridResults("random_grid", "auc", TRUE)

random_grid_summary %>% 
    pivot_longer(cols = c(col_sample_rate:sample_rate)) %>% 
    ggplot(aes(value, auc, color = name)) +
    geom_point() +
    facet_wrap(~ name, scales = "free_x") +
    theme_bw()
```

```{r}
hyper_params <- list(
    max_depth       = c(1:4),
    min_rows        = 10,
    sample_rate     = seq(0.1, 0.8, 0.1),
    col_sample_rate =seq(0.1, 0.9, 0.1)
)

random_grid <- h2o.grid(
    algorithm = "gbm",
    grid_id = "random_grid",
    x = x,
    y = y,
    training_frame = train_h2o,
    nfolds = 5,
    fold_assignment = "Stratified",
    balance_classes = TRUE,
    seed = 1234,
    hyper_params = hyper_params,
    search_criteria = list(
        strategy = "RandomDiscrete",
        max_models = 25,
        seed = 1234),
    ntrees = 100,
    stopping_rounds = 5,
    stopping_metric = "AUC",
    stopping_tolerance = 0.001
)

random_grid_summary <- h2o.gridResults("random_grid", "auc", TRUE)

random_grid_summary %>% 
    pivot_longer(cols = c(col_sample_rate:sample_rate)) %>% 
    ggplot(aes(value, auc, color = name)) +
    geom_point() +
    facet_wrap(~ name, scales = "free_x") +
    theme_bw()
```

```{r}
hyper_params <- list(
    max_depth       = c(1:3),
    min_rows        = 10,
    sample_rate     = c(0.1, 0.5, 0.75),
    col_sample_rate = c(0.1, 0.2),
    learn_rate      = c(0.1, 0.01, 0.001)
)

exhaustive_grid <- h2o.grid(
    algorithm = "gbm",
    grid_id = "exhaustive_grid",
    x = x,
    y = y,
    training_frame = train_h2o,
    nfolds = 5,
    fold_assignment = "Stratified",
    balance_classes = TRUE,
    seed = 1234,
    hyper_params = hyper_params,
    stopping_rounds = 5,
    stopping_metric = "AUC",
    stopping_tolerance = 0.001
)

exhaustive_grid_summary <- h2o.gridResults("exhaustive_grid", "auc", TRUE)

exhaustive_grid_summary %>% 
    pivot_longer(cols = c(col_sample_rate:sample_rate)) %>% 
    ggplot(aes(value, auc, color = name)) +
    geom_point() +
    facet_wrap(~ name, scales = "free_x") +
    theme_bw()
```

```{r}
hyper_params <- list(
    max_depth       = c(2:3),
    min_rows        = 10,
    sample_rate     = c(0.5, 0.75, 0.9),
    col_sample_rate = c(0.05, 0.1, 0.15),
    learn_rate      = c(0.1, 0.2)
)

exhaustive_grid <- h2o.grid(
    algorithm = "gbm",
    grid_id = "exhaustive_grid",
    x = x,
    y = y,
    training_frame = train_h2o,
    nfolds = 5,
    fold_assignment = "Stratified",
    balance_classes = TRUE,
    seed = 1234,
    hyper_params = hyper_params,
    stopping_rounds = 5,
    stopping_metric = "AUC",
    stopping_tolerance = 0.001
)

exhaustive_grid_summary <- h2o.gridResults("exhaustive_grid", "auc", TRUE)

exhaustive_grid_summary %>% 
    pivot_longer(cols = c(col_sample_rate:sample_rate)) %>% 
    ggplot(aes(value, auc, color = name)) +
    geom_point() +
    facet_wrap(~ name, scales = "free_x") +
    theme_bw()
```

```{r}
engineered_tuned_gbm <- 
    exhaustive_grid_summary %>% 
    slice_head(n = 1) %>%
    pull(model_ids) %>% 
    h2o.getModel()

h2o.saveModel(filtered_tuned_gbm, path = here("04_Modelling/models/engineered_tuned_models/"), filename = "engineered_tuned_gbm")
```
